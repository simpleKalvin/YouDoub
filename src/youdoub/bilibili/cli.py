from __future__ import annotations

import json
import subprocess
from pathlib import Path
import os
import textwrap
import typer
import httpx
from rich.console import Console

from ..paths import ensure_workdir

app = typer.Typer(no_args_is_help=True)
console = Console()


def download_cover_image(url: str, save_path: Path) -> bool:
    """Download cover image from URL to local path."""
    try:
        with httpx.Client(timeout=30.0) as client:
            response = client.get(url)
            response.raise_for_status()

            # Ensure parent directory exists
            save_path.parent.mkdir(parents=True, exist_ok=True)

            with open(save_path, 'wb') as f:
                f.write(response.content)

        console.print(f"[green]âœ… å°é¢å·²ä¸‹è½½: {save_path}[/green]")
        return True
    except Exception as e:
        console.print(f"[yellow]âš ï¸  å°é¢ä¸‹è½½å¤±è´¥: {e}[/yellow]")
        return False


@app.command("config")
def config(
    video_id: str = typer.Option(..., "--video-id", "-v", help="è§†é¢‘ ID"),
    workdir: Path = typer.Option(Path(os.getenv("YOUDOUB_WORKDIR", "./work")), "--workdir", "-w", help="Workspace directory"),
    title: str = typer.Option("", "--title", help="BiliBili title (default from meta.json if available)"),
    desc: str = typer.Option("", "--desc", help="BiliBili description"),
    tags: str = typer.Option("", "--tags", help="Comma-separated tags"),
    tid: int = typer.Option(0, "--tid", help="BiliBili partition id (tid)"),
    subtitle_mode: str = typer.Option("zh", "--subtitle-mode", help="zh or bilingual"),
    copyright: int = typer.Option(2, "--copyright", help="Copyright: 1-è‡ªåˆ¶ 2-è½¬è½½"),
    source: str = typer.Option("Youtube", "--source", help="è½¬è½½æ¥æº (å½“ copyright=2 æ—¶ä½¿ç”¨)"),
    cover: str = typer.Option("", "--cover", help="æœ¬åœ°å°é¢æ–‡ä»¶è·¯å¾„ (ç•™ç©ºåˆ™ä½¿ç”¨æŠ“å–çš„é“¾æ¥)"),
):
    """Generate biliup.yaml config in workdir/bili for later upload."""
    # Compute target workspace path
    target_root = workdir / video_id
    wp = ensure_workdir(target_root)

    console.print(f"è§†é¢‘ ID: {video_id}")
    console.print(f"å·¥ä½œç›®å½•: {target_root}")

    # choose subtitle output
    subtitle_path = wp.out_zh() if subtitle_mode == "zh" else wp.out_bilingual

    # Try load title from meta
    meta_title = ""
    thumbnail_url = ""
    if wp.meta_json.exists():
        try:
            meta = json.loads(wp.meta_json.read_text(encoding="utf-8"))
            meta_title = meta.get("title") or ""
            desc = meta.get("description") or ""
            thumbnail_url = meta.get("thumbnail") or ""
        except Exception:
            meta_title = ""

    title_final = title or meta_title or "Untitled"

    # Handle cover image
    final_cover = cover  # User provided cover parameter
    if not final_cover and thumbnail_url:
        # No user cover provided, use thumbnail from meta
        if thumbnail_url.startswith('http://') or thumbnail_url.startswith('https://'):
            # It's a URL, download it
            cover_filename = f"{video_id}_cover.jpg"
            cover_path = wp.root / cover_filename
            if download_cover_image(thumbnail_url, cover_path):
                final_cover = str(cover_path)
            # else: download failed, final_cover remains empty
        else:
            # It's already a local path
            final_cover = thumbnail_url

    cover = final_cover

    tag_list = [t.strip() for t in tags.split(",") if t.strip()]

    # biliup config template with correct streamers format
    # NOTE: biliup config schema may differ by version; user can edit this file.
    video_path_str = json.dumps(str(wp.video), ensure_ascii=False)

    # Build configuration using template
    config_data = {
        'title': title_final,
        'desc': desc or "",
        'tid': tid or 0,
        'tags': tag_list or [],
        'cover': cover,
        'copyright': copyright,
        'source': source,
    }

    # Build YAML content
    yaml_lines = [
        "# Auto-generated by youdoub",
        "# biliup configuration file",
        "",
        "streamers:",
        f"  {video_path_str}:",
        f"    title: {json.dumps(config_data['title'], ensure_ascii=False)}",
        f"    desc: {json.dumps(config_data['desc'], ensure_ascii=False)}",
        f"    tid: {config_data['tid']}",
        f"    tags: {json.dumps(config_data['tags'], ensure_ascii=False)}",
    ]

    # Only add cover if it's provided
    if config_data['cover']:
        yaml_lines.append(f"    cover: {json.dumps(config_data['cover'], ensure_ascii=False)}")

    yaml_lines.extend([
        f"    copyright: {config_data['copyright']}",
        f"    source: {json.dumps(config_data['source'], ensure_ascii=False)}",
    ])

    yaml = "\n".join(yaml_lines)

    # Subtitles: biliup support varies; we include a hint section.
    yaml += "\n\n# Subtitle hint (may require manual integration depending on biliup version)"
    yaml += "\n# subtitle:"
    yaml += f"\n#   path: {json.dumps(str(subtitle_path), ensure_ascii=False)}"

    wp.bili_config.write_text(yaml, encoding="utf-8")
    console.print(f"[green]OK[/green] wrote config: {wp.bili_config}")
    console.print("You may need to edit this yaml to match your biliup version/schema.")
    console.print(f"Hint: run `youdoub bili upload` to upload, or `youdoub bili submit` for one-click submission.")


@app.command("upload")
def upload(
    video_id: str = typer.Option(..., "--video-id", "-v", help="è§†é¢‘ ID"),
    workdir: Path = typer.Option(Path(os.getenv("YOUDOUB_WORKDIR", "./work")), "--workdir", "-w", help="Workspace directory"),
    biliup_bin: str = typer.Option("biliup", "--biliup-bin", help="biliup executable"),
):
    """Upload to BiliBili via biliup using workdir/bili/biliup.yaml."""
    # Compute target workspace path
    target_root = workdir / video_id
    wp = ensure_workdir(target_root)

    console.print(f"è§†é¢‘ ID: {video_id}")
    console.print(f"å·¥ä½œç›®å½•: {target_root}")

    if not wp.bili_config.exists():
        console.print(f"[red]Error: Missing biliup config {wp.bili_config}[/red]")
        console.print("Hint: run `youdoub bili config ...` first.")
        raise typer.Exit(1)

    # Check if biliup is installed
    try:
        if biliup_bin == "biliup":
            subprocess.run(["uv", "run", "biliup", "--version"], capture_output=True, check=True)
        else:
            subprocess.run([biliup_bin, "--version"], capture_output=True, check=True)
    except (subprocess.CalledProcessError, FileNotFoundError):
        console.print(f"[red]âŒ biliup æœªå®‰è£…æˆ–æ— æ³•æ‰¾åˆ°[/red]")
        console.print()
        console.print("[blue]å®‰è£… biliup çš„æ–¹æ³•ï¼š[/blue]")
        console.print("1. ä½¿ç”¨ uv å®‰è£… (æ¨è):")
        console.print("   [cyan]uv pip install biliup[/cyan]")
        console.print()
        console.print("2. æˆ–è€…ä½¿ç”¨ pip å®‰è£…:")
        console.print("   [cyan]pip install biliup[/cyan]")
        console.print()
        console.print("3. éªŒè¯å®‰è£…:")
        console.print("   [cyan]uv run biliup --version[/cyan]")
        console.print()
        console.print(f"4. é…ç½® BiliBili è´¦å·:")
        console.print("   [cyan]uv run biliup login[/cyan]")
        console.print()
        console.print("å®‰è£…å®Œæˆåé‡æ–°è¿è¡Œæ­¤å‘½ä»¤ã€‚")
        raise typer.Exit(1)

    # Call biliup via uv run if biliup_bin is 'biliup' (default)
    if biliup_bin == "biliup":
        cmd = ["uv", "run", "biliup", "upload", "-c", str(wp.bili_config)]
    else:
        cmd = [biliup_bin, "upload", "-c", str(wp.bili_config)]
    console.print("Running: " + " ".join(cmd))

    try:
        cp = subprocess.run(cmd)
    except FileNotFoundError as e:
        if biliup_bin == "biliup":
            console.print(f"[red]âŒ æ— æ³•æ‰¾åˆ° biliup å‘½ä»¤: {e}[/red]")
            console.print("è¯·ç¡®ä¿ biliup å·²é€šè¿‡ uv å®‰è£…: uv pip install biliup")
            console.print("ç„¶åä½¿ç”¨: uv run biliup --version")
        else:
            console.print(f"[red]âŒ æ— æ³•æ‰¾åˆ° biliup å‘½ä»¤: {e}[/red]")
            console.print(f"æŒ‡å®šçš„ biliup å¯æ‰§è¡Œæ–‡ä»¶ä¸å­˜åœ¨: {biliup_bin}")
        raise typer.Exit(1)

    result = {
        "command": cmd,
        "returncode": cp.returncode,
    }
    wp.bili_result.write_text(json.dumps(result, ensure_ascii=False, indent=2), encoding="utf-8")

    if cp.returncode != 0:
        console.print(f"[red]âŒ ä¸Šä¼ å¤±è´¥[/red], è¿”å›ç ={cp.returncode}")
        console.print(f"è¯¦ç»†ç»“æœè¯·æŸ¥çœ‹: {wp.bili_result}")
        console.print()
        console.print("[blue]å¸¸è§è§£å†³æ–¹æ¡ˆï¼š[/blue]")
        console.print("1. æ£€æŸ¥ BiliBili è´¦å·æ˜¯å¦å·²ç™»å½•: [cyan]biliup login[/cyan]")
        console.print("2. æ£€æŸ¥è§†é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”ä¸æŸå")
        console.print("3. æ£€æŸ¥ç½‘ç»œè¿æ¥")
        console.print("4. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—")
        raise typer.Exit(cp.returncode)

    console.print(f"[green]OK[/green] upload finished. Result: {wp.bili_result}")


@app.command("submit")
def submit(
    video_id: str = typer.Option(..., "--video-id", "-v", help="è§†é¢‘ ID"),
    workdir: Path = typer.Option(Path(os.getenv("YOUDOUB_WORKDIR", "./work")), "--workdir", "-w", help="Workspace directory"),
    title: str = typer.Option("", "--title", help="BiliBili title (default from meta.json if available)"),
    desc: str = typer.Option("", "--desc", help="BiliBili description"),
    tags: str = typer.Option("", "--tags", help="Comma-separated tags"),
    tid: int = typer.Option(0, "--tid", help="BiliBili partition id (tid)"),
    subtitle_mode: str = typer.Option("zh", "--subtitle-mode", help="zh or bilingual"),
    biliup_bin: str = typer.Option("biliup", "--biliup-bin", help="biliup executable"),
    force_config: bool = typer.Option(False, "--force-config", help="Regenerate config even if it exists"),
    copyright: int = typer.Option(1, "--copyright", help="Copyright: 1-è‡ªåˆ¶ 2-è½¬è½½"),
    source: str = typer.Option("Youtube", "--source", help="è½¬è½½æ¥æº (å½“ copyright=2 æ—¶ä½¿ç”¨)"),
    cover: str = typer.Option("", "--cover", help="æœ¬åœ°å°é¢æ–‡ä»¶è·¯å¾„ (ç•™ç©ºåˆ™ä¸è®¾ç½®å°é¢)"),
):
    """One-click submit: auto-generate config and upload to BiliBili."""
    # Compute target workspace path
    target_root = workdir / video_id
    wp = ensure_workdir(target_root)

    console.print(f"è§†é¢‘ ID: {video_id}")
    console.print(f"å·¥ä½œç›®å½•: {target_root}")

    console.print(f"ğŸš€ å¼€å§‹ä¸€é”®æŠ•ç¨¿æµç¨‹: {workdir}")
    console.print()

    # Step 1: æ£€æŸ¥å¿…è¦æ–‡ä»¶
    console.print("ğŸ“‹ æ£€æŸ¥å¿…è¦æ–‡ä»¶...")

    if not wp.video.exists():
        console.print(f"[red]âŒ æ‰¾ä¸åˆ°è§†é¢‘æ–‡ä»¶: {wp.video}[/red]")
        console.print("è¯·å…ˆè¿è¡Œä¸‹è½½å‘½ä»¤: youdoub yt dl <url>")
        console.print()
        console.print("[blue]ğŸ’¡ å®Œæ•´å·¥ä½œæµç¨‹:[/blue]")
        console.print("   1. youdoub yt dl \"https://youtube.com/watch?v=VIDEO_ID\"")
        console.print("   2. youdoub yt translate-subs --lang zh-CN --backend deepseek --whole-file")
        console.print("   3. youdoub bili submit --title \"è§†é¢‘æ ‡é¢˜\"")
        raise typer.Exit(1)

    # æ£€æŸ¥å­—å¹•æ–‡ä»¶ï¼ˆæ ¹æ®æ¨¡å¼ï¼‰
    subtitle_path = wp.out_zh() if subtitle_mode == "zh" else wp.out_bilingual
    subtitle_exists = subtitle_path.exists()

    console.print(f"[green]âœ… è§†é¢‘æ–‡ä»¶: {wp.video}[/green]")
    if subtitle_exists:
        console.print(f"[green]âœ… å­—å¹•æ–‡ä»¶: {subtitle_path} ({subtitle_mode})[/green]")
    else:
        console.print(f"[yellow]âš ï¸  æ‰¾ä¸åˆ°å­—å¹•æ–‡ä»¶: {subtitle_path}[/yellow]")
        console.print("å°†ä¸Šä¼ æ— å­—å¹•ç‰ˆæœ¬")

    # æ£€æŸ¥æ˜¯å¦æœ‰ç¿»è¯‘åçš„å­—å¹•
    translated_sub = wp.translated_sub_srt()
    if not subtitle_exists and translated_sub.exists():
        console.print(f"[blue]ğŸ’¡ å‘ç°ç¿»è¯‘å­—å¹•: {translated_sub}[/blue]")
        console.print("å»ºè®®å…ˆç”Ÿæˆæœ€ç»ˆå­—å¹•æ–‡ä»¶")

    # Step 2: ç”Ÿæˆæˆ–æ£€æŸ¥é…ç½®
    console.print()
    console.print("âš™ï¸  é…ç½®æ£€æŸ¥...")

    config_exists = wp.bili_config.exists()
    if not config_exists or force_config:
        console.print("ğŸ“ ç”Ÿæˆ biliup é…ç½®...")
        try:
            config(
                video_id=video_id,
                workdir=workdir,
                title=title,
                desc=desc,
                tags=tags,
                tid=tid,
                subtitle_mode=subtitle_mode,
                copyright=copyright,
                source=source,
                cover=cover,
            )
        except Exception as e:
            console.print(f"[red]âŒ é…ç½®ç”Ÿæˆå¤±è´¥: {e}[/red]")
            raise typer.Exit(1)
    else:
        console.print(f"[green]âœ… ä½¿ç”¨ç°æœ‰é…ç½®: {wp.bili_config}[/green]")

    # Step 3: æ‰§è¡Œä¸Šä¼ 
    console.print()
    console.print("ğŸ“¤ å¼€å§‹ä¸Šä¼ åˆ° BiliBili...")

    try:
        upload(
            workdir=workdir,
            biliup_bin=biliup_bin,
        )
    except Exception as e:
        console.print(f"[red]âŒ ä¸Šä¼ å¤±è´¥: {e}[/red]")
        raise typer.Exit(1)

    # Step 4: å®Œæˆæ€»ç»“
    console.print()
    console.print("ğŸ‰ æŠ•ç¨¿æµç¨‹å®Œæˆï¼")
    console.print(f"ğŸ“ å·¥ä½œç›®å½•: {workdir}")
    console.print(f"ğŸ“Š ä¸Šä¼ ç»“æœ: {wp.bili_result}")

    # æ˜¾ç¤ºç»“æœæ‘˜è¦
    if wp.bili_result.exists():
        try:
            result = json.loads(wp.bili_result.read_text(encoding="utf-8"))
            returncode = result.get("returncode", -1)
            if returncode == 0:
                console.print("[green]âœ… ä¸Šä¼ æˆåŠŸï¼[/green]")
            else:
                console.print(f"[red]âŒ ä¸Šä¼ å¤±è´¥ï¼Œè¿”å›ç : {returncode}[/red]")
        except Exception:
            console.print("[yellow]âš ï¸  æ— æ³•è¯»å–ä¸Šä¼ ç»“æœè¯¦æƒ…[/yellow]")


@app.command("workflow")
def workflow():
    """Show the complete YouDoub to BiliBili workflow."""
    console.print("[bold blue]ğŸš€ YouDoub å®Œæ•´å·¥ä½œæµç¨‹[/bold blue]")
    console.print()

    console.print("[bold]ç¬¬ä¸€é˜¶æ®µ: å‡†å¤‡è§†é¢‘å’Œå­—å¹•[/bold]")
    console.print("1. ä¸‹è½½ YouTube è§†é¢‘:")
    console.print("   [cyan]youdoub yt dl \"https://youtube.com/watch?v=VIDEO_ID\"[/cyan]")
    console.print()

    console.print("2. è·å–å­—å¹• (å¯é€‰):")
    console.print("   [cyan]youdoub yt sub --video-id VIDEO_ID[/cyan]")
    console.print()

    console.print("3. ç¿»è¯‘å­—å¹•:")
    console.print("   [cyan]youdoub yt translate-subs --video-id VIDEO_ID --lang zh-CN --backend deepseek --whole-file --merge-timelines --model deepseek-reasoner[/cyan]")
    console.print()

    console.print("[bold]ç¬¬äºŒé˜¶æ®µ: ç”Ÿæˆæœ€ç»ˆè¾“å‡º[/bold]")
    console.print("4. ç”ŸæˆåŒè¯­å­—å¹• (å¯é€‰):")
    console.print("   [cyan]create_bilingual_subs.py[/cyan]")
    console.print()

    console.print("[bold]ç¬¬ä¸‰é˜¶æ®µ: æŠ•ç¨¿åˆ° BiliBili[/bold]")
    console.print("5. ä¸€é”®æŠ•ç¨¿ (æ¨è):")
    console.print("   [cyan]youdoub bili submit --video-id VIDEO_ID --title \"è§†é¢‘æ ‡é¢˜\" --desc \"è§†é¢‘æè¿°\" --tags \"æ ‡ç­¾1,æ ‡ç­¾2\" --tid 123[/cyan]")
    console.print()

    console.print("   æˆ–è€…åˆ†æ­¥æ‰§è¡Œ:")
    console.print("   a) ç”Ÿæˆé…ç½®:")
    console.print("      [cyan]youdoub bili config --video-id VIDEO_ID --title \"è§†é¢‘æ ‡é¢˜\" --desc \"è§†é¢‘æè¿°\"[/cyan]")
    console.print("   b) æ‰§è¡Œä¸Šä¼ :")
    console.print("      [cyan]youdoub bili upload --video-id VIDEO_ID[/cyan]")
    console.print()

    console.print("[bold green]ğŸ’¡ æç¤º:[/bold green]")
    console.print("- æ‰€æœ‰å‘½ä»¤éƒ½åœ¨åŒä¸€å·¥ä½œç›®å½• (é»˜è®¤ ./work) ä¸­è¿è¡Œ")
    console.print("- ç¡®ä¿å·²å®‰è£… biliup å¹¶é…ç½®å¥½ BiliBili è´¦å·")
    console.print("- ä½¿ç”¨ --workdir æŒ‡å®šä¸åŒå·¥ä½œç›®å½•æ¥å¤„ç†å¤šä¸ªè§†é¢‘")
    console.print("- ä¸€é”®æŠ•ç¨¿ submit å‘½ä»¤ä¼šè‡ªåŠ¨æ£€æŸ¥æ–‡ä»¶å¹¶ç”Ÿæˆé…ç½®")

